package TestEnv;

use strict;
use warnings;

use File::Basename 'dirname';
use File::Spec;
use Sys::Hostname;

INIT { # runs after compilation, right before execution
    my $repo_path = resolve_repo_path( (caller())[1] );
    $ENV{REFIMP_CONFIG_FILE} = File::Spec->join($repo_path, 't.d', 'config.test.yml');
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;

    my $lib = File::Spec->join($repo_path, 'lib');
    eval "use lib '$lib';";
    die "FATAL: $@" if $@;

    my $use = <<USE;
    use RefImp;
    use RefImp::Test;
    use RefImp::Test::Factory;
USE
    eval $use;
    die "FATAL: $@" if $@;

    printf(STDERR "***** TEST ENV on %s *****\n", Sys::Hostname::hostname);
}

sub resolve_repo_path {
    my $file = shift;
    die "No file given to resolve lib path!" if not $file;
    die "File given to resolve lib path does not exist!" if not -e $file;
    my @directory_parts = File::Spec->splitdir( File::Spec->rel2abs( dirname($file) ) );
    pop @directory_parts;
    File::Spec->join(@directory_parts);
}

1;

